{% extends "base.html" %}

{% block title %}Find Near You - Appointment Scheduler{% endblock %}

{% block content %}
<h2 class="mb-4" data-translate="find-near-you">Find Near You</h2>
<p class="text-muted mb-4" data-translate="find-near-you-description">Discover providers in your local area</p>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-map me-2"></i><span data-translate="serbia-map">Serbia Map</span>
        </h5>
    </div>
    <div class="card-body p-0">
        <div id="map" style="height: 600px; width: 100%;"></div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<script>
let map;
let markers = [];
let userMarker = null;

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    initMap();
});

// Initialize OpenStreetMap using Leaflet
function initMap() {
    try {
        const mapElement = document.getElementById('map');
        if (!mapElement) {
            console.error('Map element not found');
            return;
        }

        // Create map centered on Serbia
        map = L.map('map').setView([44.0165, 21.0059], 7);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Store map reference globally
        window.map = map;
        
        // Add custom controls
        addMapControls();
        
        // Load and display provider pins
        loadProviderPins();
    } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('map').innerHTML = '<div class="alert alert-danger m-3">Error loading map. Please refresh the page.</div>';
    }
}

// Load provider pins from API
async function loadProviderPins() {
    try {
        const response = await fetch('/api/providers');
        const providers = await response.json();
        
        // Add pins for each provider
        for (const provider of providers) {
            await addProviderPin(provider);
        }
    } catch (error) {
        console.error('Error loading providers:', error);
    }
}

// Add pin to map using stored coordinates or geocode if needed
async function addProviderPin(provider) {
    try {
        let lat, lng;
        
        // Check if provider has stored coordinates
        if (provider.latitude && provider.longitude) {
            lat = parseFloat(provider.latitude);
            lng = parseFloat(provider.longitude);
        } else if (provider.address) {
            // Fallback to geocoding if coordinates not available
            const coords = await geocodeAddress(provider.address);
            if (coords) {
                lat = coords.lat;
                lng = coords.lng;
            } else {
                console.warn(`Could not geocode address for ${provider.business_name}`);
                return; // Skip this provider if geocoding fails
            }
        } else {
            console.warn(`No address or coordinates for ${provider.business_name}`);
            return; // Skip this provider if no address
        }
        
        // Create custom icon
        const providerIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background-color: #007bff; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        
        // Create marker
        const marker = L.marker([lat, lng], { icon: providerIcon })
            .addTo(map)
            .bindPopup(createProviderPopup(provider));
        
        // Store marker reference
        markers.push(marker);
        
    } catch (error) {
        console.error(`Error adding pin for ${provider.business_name}:`, error);
    }
}

// Geocode address using OpenStreetMap Nominatim API (free, no API key needed)
async function geocodeAddress(address) {
    try {
        // Use Nominatim API for geocoding
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`, {
            headers: {
                'User-Agent': 'AppointmentScheduler/1.0'
            }
        });
        
        const data = await response.json();
        
        if (data && data.length > 0) {
            return {
                lat: parseFloat(data[0].lat),
                lng: parseFloat(data[0].lon)
            };
        } else {
            console.error(`Geocoding failed for "${address}"`);
            return null;
        }
    } catch (error) {
        console.error(`Error geocoding address "${address}":`, error);
        return null;
    }
}

// Create popup content for provider
function createProviderPopup(provider) {
    const serviceIcons = {
        'hair_salon': 'fas fa-cut',
        'nail_salon': 'fas fa-hand-sparkles',
        'massage_therapy': 'fas fa-spa',
        'spa_treatment': 'fas fa-leaf',
        'personal_training': 'fas fa-dumbbell',
        'yoga_classes': 'fas fa-om',
        'pilates': 'fas fa-running',
        'dermatology': 'fas fa-user-md',
        'physical_therapy': 'fas fa-heartbeat',
        'nutrition_counseling': 'fas fa-apple-alt',
        'makeup_artist': 'fas fa-palette',
        'photography': 'fas fa-camera',
        'life_coaching': 'fas fa-lightbulb',
        'eyebrow_eyelash': 'fas fa-eye',
        'aromatherapy': 'fas fa-seedling'
    };
    
    const serviceNames = {
        'hair_salon': 'Hair Salon',
        'nail_salon': 'Nail Salon',
        'massage_therapy': 'Massage Therapy',
        'spa_treatment': 'Spa Treatment',
        'personal_training': 'Personal Training',
        'yoga_classes': 'Yoga Classes',
        'pilates': 'Pilates',
        'dermatology': 'Dermatology',
        'physical_therapy': 'Physical Therapy',
        'nutrition_counseling': 'Nutrition Consulting',
        'makeup_artist': 'Makeup Artist',
        'photography': 'Photography',
        'life_coaching': 'Life Coaching',
        'eyebrow_eyelash': 'Eyebrow & Eyelash',
        'aromatherapy': 'Aromatherapy'
    };
    
    const icon = serviceIcons[provider.service_category] || 'fas fa-store';
    const serviceName = serviceNames[provider.service_category] || 'Service Provider';
    
    // Use services_offered if available, otherwise use the service category name
    const servicesText = provider.services_offered && provider.services_offered.trim() !== '' 
        ? provider.services_offered 
        : serviceName;
    
    return `
        <div class="map-popup" style="min-width: 250px; max-width: 300px;">
            <div class="d-flex align-items-center mb-2">
                <i class="${icon} me-2 text-primary"></i>
                <h6 class="mb-0" style="color: #007bff; font-weight: 600;">${provider.business_name}</h6>
            </div>
            <p class="text-muted small mb-2">${provider.business_description || serviceName + ' services'}</p>
            <div class="mb-2">
                <strong>Services:</strong><br>
                <span class="small">${servicesText}</span>
            </div>
            <div class="mb-2">
                <i class="fas fa-map-marker-alt me-1 text-danger"></i>
                <span class="small">${provider.address}</span>
            </div>
            ${provider.phone ? `
            <div class="mb-2">
                <i class="fas fa-phone me-1 text-success"></i>
                <span class="small">${provider.phone}</span>
            </div>
            ` : ''}
            <div class="text-center">
                <a href="/providers/${provider.service_category.replace('_', '-')}" class="btn btn-primary btn-sm" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                    <i class="fas fa-calendar-plus me-1"></i>Book Now
                </a>
            </div>
        </div>
    `;
}

// Get current location
function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Center map on user location
                map.setView([lat, lng], 10);
                
                // Remove existing user marker if present
                if (userMarker) {
                    map.removeLayer(userMarker);
                }
                
                // Create custom icon for user location
                const userIcon = L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background-color: #28a745; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                // Add user location marker
                userMarker = L.marker([lat, lng], { icon: userIcon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="map-popup">
                            <h6 class="mb-2"><i class="fas fa-user me-1"></i>Your Location</h6>
                            <p class="text-muted mb-0">Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}</p>
                        </div>
                    `)
                    .openPopup();
            },
            function(error) {
                alert('Unable to get your current location. Please try again.');
            }
        );
    } else {
        alert('Geolocation is not supported by this browser.');
    }
}

// Show all providers (reset to Serbia view)
function showAllProviders() {
    map.setView([44.0165, 21.0059], 7);
}

// Add custom controls when map is ready
function addMapControls() {
    if (map) {
        // Create custom control container
        const controlDiv = document.createElement('div');
        controlDiv.style.cssText = 'margin: 10px; background: white; border-radius: 0.375rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 0.5rem; z-index: 1000;';
        
        // Get translations for button titles
        const lang = localStorage.getItem('language') || 'en';
        const translations = window.translations && window.translations[lang] ? window.translations[lang] : {};
        const serbiaViewTitle = translations['serbia-view'] || 'Serbia View';
        const myLocationTitle = translations['my-location'] || 'My Location';
        const showAllTitle = translations['show-all-providers'] || 'Show All Providers';
        
        const controlHTML = `
            <div class="btn-group-vertical" role="group">
                <button class="btn btn-outline-primary btn-sm" onclick="showAllProviders()" title="${serbiaViewTitle}" style="margin-bottom: 0.25rem;">
                    <i class="fas fa-map"></i>
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="getCurrentLocation()" title="${myLocationTitle}" style="margin-bottom: 0.25rem;">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="showAllProviders()" title="${showAllTitle}">
                    <i class="fas fa-list"></i>
                </button>
            </div>
        `;
        controlDiv.innerHTML = controlHTML;
        
        // Add to map
        map.getContainer().appendChild(controlDiv);
    }
}

</script>

<style>
/* Map styling */
#map {
    border-radius: 0 0 0.375rem 0.375rem;
    z-index: 1;
}

/* Map popup styling */
.map-popup {
    min-width: 250px;
    max-width: 300px;
}

.map-popup h6 {
    color: #007bff;
    font-weight: 600;
}

.map-popup .btn {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
}

/* Leaflet popup customization */
.leaflet-popup-content-wrapper {
    border-radius: 0.75rem;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border: 1px solid rgba(0,0,0,0.1);
}

.leaflet-popup-content {
    margin: 15px;
}

/* Custom marker styling */
.custom-marker {
    background: transparent;
    border: none;
}

/* Responsive map */
@media (max-width: 768px) {
    #map {
        height: 400px;
    }
}
</style>
{% endblock %}
